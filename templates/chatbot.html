{% extends "base.html" %}

{% block title %}AI Assistant - Flight Scheduling MVP{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h2><i class="bi bi-robot text-primary"></i> AI Flight Scheduling Assistant</h2>
    <p class="text-muted">Ask questions about flight scheduling, delays, and optimization strategies</p>
</div>

<div class="row">
    <div class="col-lg-9 col-md-12">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-status">
                    <div class="status-indicator online"></div>
                    <div class="status-info">
                        <h6>Flight Assistant AI</h6>
                        <p class="mb-0">Powered by Google Gemini</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <p>Hello! I'm your AI flight scheduling assistant. I can help you with:</p>
                            <ul>
                                <li>Finding the best times for flights</li>
                                <li>Understanding delay patterns</li>
                                <li>Airport congestion insights</li>
                                <li>Schedule optimization recommendations</li>
                            </ul>
                            <p>What would you like to know about Mumbai Airport operations?</p>
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <form id="chatForm" class="chat-input-form">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control chat-input" 
                               id="messageInput" 
                               placeholder="Ask about flight scheduling, delays, or optimization..."
                               autocomplete="off">
                        <button class="btn btn-primary" type="submit" id="sendButton">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>
                
                <div class="quick-questions mt-3">
                    <p class="mb-2 text-muted"><small>Quick questions:</small></p>
                    <div class="question-buttons">
                        <button class="btn btn-sm btn-outline-primary question-btn" data-question="What are the best times to schedule flights at Mumbai Airport?">
                            Best flight times
                        </button>
                        <button class="btn btn-sm btn-outline-primary question-btn" data-question="Which hours have the most delays?">
                            Delay patterns
                        </button>
                        <button class="btn btn-sm btn-outline-primary question-btn" data-question="How can I optimize my flight schedule?">
                            Schedule optimization
                        </button>
                        <button class="btn btn-sm btn-outline-primary question-btn" data-question="What causes cascading delays at the airport?">
                            Cascading delays
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-12">
        <div class="chat-sidebar">
            <div class="sidebar-section">
                <h6><i class="bi bi-info-circle"></i> AI Capabilities</h6>
                <div class="capability-list">
                    <div class="capability-item">
                        <i class="bi bi-clock text-primary"></i>
                        <span>Delay pattern analysis</span>
                    </div>
                    <div class="capability-item">
                        <i class="bi bi-graph-up text-success"></i>
                        <span>Traffic optimization</span>
                    </div>
                    <div class="capability-item">
                        <i class="bi bi-diagram-3 text-warning"></i>
                        <span>Impact assessment</span>
                    </div>
                    <div class="capability-item">
                        <i class="bi bi-lightbulb text-info"></i>
                        <span>Smart recommendations</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h6><i class="bi bi-question-circle"></i> Sample Questions</h6>
                <div class="sample-questions">
                    <p>"When is the best time to schedule departures to minimize delays?"</p>
                    <p>"What are the busiest hours at Mumbai Airport?"</p>
                    <p>"How do weather delays impact the flight schedule?"</p>
                    <p>"What's the average delay for flights between 7-9 AM?"</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isTyping = false;

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
});

// Quick question buttons
document.querySelectorAll('.question-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const question = this.getAttribute('data-question');
        document.getElementById('messageInput').value = question;
        sendMessage();
    });
});

async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message || isTyping) return;
    
    // Add user message
    addMessage(message, 'user');
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        // Remove typing indicator
        hideTypingIndicator();
        
        // Add bot response
        addMessage(data.response, 'bot');
        
    } catch (error) {
        hideTypingIndicator();
        addMessage('Sorry, I encountered an error. Please try again later.', 'bot');
        console.error('Chat error:', error);
    }
}

function addMessage(content, sender) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble">
                    <p>${content}</p>
                </div>
                <div class="message-time">${timeStr}</div>
            </div>
            <div class="message-avatar">
                <i class="bi bi-person"></i>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="bi bi-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-bubble">
                    <p>${content}</p>
                </div>
                <div class="message-time">${timeStr}</div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    isTyping = true;
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.id = 'typingIndicator';
    
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Disable send button
    document.getElementById('sendButton').disabled = true;
}

function hideTypingIndicator() {
    isTyping = false;
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
    
    // Enable send button
    document.getElementById('sendButton').disabled = false;
}

function clearChat() {
    const messagesContainer = document.getElementById('chatMessages');
    // Keep only the initial welcome message
    const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
    messagesContainer.innerHTML = '';
    messagesContainer.appendChild(welcomeMessage);
}
</script>
{% endblock %}